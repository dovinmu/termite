name: Termite Container

on:
  # Called from termite-release.yml after GoReleaser completes
  workflow_call:
    inputs:
      tag_name:
        description: "The release tag name (e.g., termite-v0.1.0)"
        required: true
        type: string
  # Allow manual triggering for standalone container builds
  workflow_dispatch:
    inputs:
      tag_name:
        description: "The release tag name (e.g., termite-v0.1.0)"
        required: false
        type: string

env:
  # Google Artifact Registry configuration
  GAR_LOCATION: us-east5
  GAR_PROJECT: antfly-image-artifacts
  GAR_REPOSITORY: antfly-labs

jobs:
  # Build and publish Termite inference images
  publish-termite-images:
    runs-on:
      - codebuild-GitHubActionsRunnerTermite-${{ github.run_id }}-${{ github.run_attempt }}
    permissions:
      contents: read
      packages: write
      id-token: write # Required for keyless signing with OIDC and GCP WIF

    steps:
      - uses: actions/checkout@v6

      # Authenticate with Docker Hub to avoid rate limits when pulling base images
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Set up QEMU for multi-architecture emulation
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # Set up Docker Buildx for advanced build features
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Authenticate with GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Authenticate to Google Cloud using Workload Identity Federation
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          token_format: "access_token"

      # Login to Google Artifact Registry
      - name: Login to Google Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GAR_LOCATION }}-docker.pkg.dev
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}

      # Extract version from tag (e.g., termite-v0.1.0 -> v0.1.0)
      - name: Extract version
        id: version
        run: |
          TAG="${{ inputs.tag_name || github.ref_name }}"
          VERSION="${TAG#termite-}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION}"

      # Build termite:latest (base image for model pulling, multi-arch)
      - name: Build and push termite:latest
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.termite
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/antflydb/termite:latest
            ghcr.io/antflydb/termite:${{ steps.version.outputs.version }}
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_PROJECT }}/${{ env.GAR_REPOSITORY }}/termite:latest
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_PROJECT }}/${{ env.GAR_REPOSITORY }}/termite:${{ steps.version.outputs.version }}
          cache-from: type=gha,scope=termite-base-bookworm
          cache-to: type=gha,mode=max,scope=termite-base-bookworm

      # Build termite:xla-tpu (TPU inference, amd64 only)
      - name: Build and push termite:xla-tpu
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.termite-xla
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/antflydb/termite:xla-tpu
            ghcr.io/antflydb/termite:xla-tpu-${{ steps.version.outputs.version }}
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_PROJECT }}/${{ env.GAR_REPOSITORY }}/termite:xla-tpu
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_PROJECT }}/${{ env.GAR_REPOSITORY }}/termite:xla-tpu-${{ steps.version.outputs.version }}
          cache-from: type=gha,scope=termite-xla-bookworm
          cache-to: type=gha,mode=max,scope=termite-xla-bookworm

      # Build termite:onnx (GPU/ONNX inference, amd64 only)
      - name: Build and push termite:onnx
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.termite-onnx
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/antflydb/termite:onnx
            ghcr.io/antflydb/termite:onnx-${{ steps.version.outputs.version }}
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_PROJECT }}/${{ env.GAR_REPOSITORY }}/termite:onnx
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_PROJECT }}/${{ env.GAR_REPOSITORY }}/termite:onnx-${{ steps.version.outputs.version }}
          cache-from: type=gha,scope=termite-onnx-bookworm
          cache-to: type=gha,mode=max,scope=termite-onnx-bookworm

      # Install cosign for container image signing
      - uses: sigstore/cosign-installer@v3

      # Sign all images with keyless OIDC
      - name: Sign container images (keyless)
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Sign termite images
          for tag in latest "${VERSION}"; do
            cosign sign --yes \
              -a "repo=${{ github.repository }}" \
              -a "workflow=${{ github.workflow }}" \
              -a "ref=${{ github.sha }}" \
              ghcr.io/antflydb/termite:${tag}
          done

          # Sign termite:xla-tpu images
          for tag in xla-tpu "xla-tpu-${VERSION}"; do
            cosign sign --yes \
              -a "repo=${{ github.repository }}" \
              -a "workflow=${{ github.workflow }}" \
              -a "ref=${{ github.sha }}" \
              ghcr.io/antflydb/termite:${tag}
          done

          # Sign termite:onnx images
          for tag in onnx "onnx-${VERSION}"; do
            cosign sign --yes \
              -a "repo=${{ github.repository }}" \
              -a "workflow=${{ github.workflow }}" \
              -a "ref=${{ github.sha }}" \
              ghcr.io/antflydb/termite:${tag}
          done

      # Sign GAR images
      - name: Sign GAR images (keyless)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          GAR_BASE="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_PROJECT }}/${{ env.GAR_REPOSITORY }}"

          # Sign termite images
          for tag in latest "${VERSION}"; do
            cosign sign --yes \
              -a "repo=${{ github.repository }}" \
              -a "workflow=${{ github.workflow }}" \
              -a "ref=${{ github.sha }}" \
              ${GAR_BASE}/termite:${tag}
          done

          # Sign termite:xla-tpu images
          for tag in xla-tpu "xla-tpu-${VERSION}"; do
            cosign sign --yes \
              -a "repo=${{ github.repository }}" \
              -a "workflow=${{ github.workflow }}" \
              -a "ref=${{ github.sha }}" \
              ${GAR_BASE}/termite:${tag}
          done

          # Sign termite:onnx images
          for tag in onnx "onnx-${VERSION}"; do
            cosign sign --yes \
              -a "repo=${{ github.repository }}" \
              -a "workflow=${{ github.workflow }}" \
              -a "ref=${{ github.sha }}" \
              ${GAR_BASE}/termite:${tag}
          done
