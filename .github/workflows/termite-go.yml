# Build and test Termite with different inference backends
#
# Uses matrix strategy to test:
# - default: Pure Go backend (full tests)
# - onnx: ONNX Runtime backend (build + tests)
# - xla: GoMLX XLA backend with PJRT CPU plugin (build + tests)

name: Termite Go

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  TOKENIZERS_VERSION: "1.24.0"
  ONNXRUNTIME_VERSION: "1.23.2"
  PJRT_CPU_VERSION: "0.83.1"

jobs:
  test:
    name: Test (${{ matrix.backend }})
    runs-on:
      - codebuild-GitHubActionsRunnerTermite-${{ github.run_id }}-${{ github.run_attempt }}
    strategy:
      fail-fast: false
      matrix:
        backend: [pure-go, onnx, xla]
        include:
          - backend: pure-go
            tags: ""
            cgo: "0"
            test_paths: "./..."
          - backend: onnx
            tags: "onnx,ORT"
            cgo: "1"
            test_paths: "./pkg/termite/..."
          - backend: xla
            tags: "xla,XLA"
            cgo: "1"
            test_paths: "./pkg/termite/..."

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"

      - name: Install build dependencies
        if: matrix.cgo == '1'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config curl

      - name: Download libtokenizers
        if: matrix.cgo == '1'
        run: |
          ARCH=$([ "$(uname -m)" = "aarch64" ] && echo "arm64" || echo "amd64")
          curl -fsSL "https://github.com/daulet/tokenizers/releases/download/v${TOKENIZERS_VERSION}/libtokenizers.linux-${ARCH}.tar.gz" \
            | sudo tar -xzf - -C /usr/local/lib
          sudo ldconfig

      - name: Download ONNX Runtime
        if: matrix.backend == 'onnx'
        run: |
          ARCH=$([ "$(uname -m)" = "aarch64" ] && echo "aarch64" || echo "x64")
          mkdir -p /tmp/onnxruntime
          curl -fsSL "https://github.com/microsoft/onnxruntime/releases/download/v${ONNXRUNTIME_VERSION}/onnxruntime-linux-${ARCH}-${ONNXRUNTIME_VERSION}.tgz" \
            | tar -xzf - --strip-components=1 -C /tmp/onnxruntime
          # Set env vars for subsequent steps
          echo "CGO_CFLAGS=-I/tmp/onnxruntime/include" >> $GITHUB_ENV
          echo "CGO_LDFLAGS=-L/tmp/onnxruntime/lib -lonnxruntime" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=/tmp/onnxruntime/lib:/usr/local/lib" >> $GITHUB_ENV
          echo "ORT_DYLIB_PATH=/tmp/onnxruntime/lib/libonnxruntime.so" >> $GITHUB_ENV

      - name: Download PJRT CPU plugin
        if: matrix.backend == 'xla'
        run: |
          sudo mkdir -p /usr/local/lib/go-xla
          curl -fsSL "https://github.com/gomlx/pjrt-cpu-binaries/releases/download/v${PJRT_CPU_VERSION}/pjrt_cpu_linux_amd64.tar.gz" \
            | sudo tar -xzf - -C /usr/local/lib/go-xla
          sudo ldconfig
          # Set env vars for subsequent steps
          echo "LD_LIBRARY_PATH=/usr/local/lib/go-xla:/usr/local/lib" >> $GITHUB_ENV
          echo "GOMLX_BACKEND=xla:cpu" >> $GITHUB_ENV

      - name: Download dependencies
        run: go mod download

      - name: Build
        env:
          CGO_ENABLED: ${{ matrix.cgo }}
        run: |
          if [ -n "${{ matrix.tags }}" ]; then
            go build -v -tags="${{ matrix.tags }}" ./...
          else
            go build -v ./...
          fi

      - name: Test
        env:
          CGO_ENABLED: ${{ matrix.cgo }}
        run: |
          if [ -n "${{ matrix.tags }}" ]; then
            go test -v -tags="${{ matrix.tags }}" ${{ matrix.test_paths }}
          else
            # Use make test for pure-go to include envtest setup for operator tests
            make test
          fi
