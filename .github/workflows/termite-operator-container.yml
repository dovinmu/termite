name: Termite Operator Container

on:
  # Trigger on tags matching termite-operator-v*
  push:
    tags:
      - "termite-operator-v*"
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      tag_name:
        description: "The release tag name (e.g., termite-operator-v0.1.0)"
        required: false
        type: string

env:
  # Google Artifact Registry configuration
  GAR_LOCATION: us-east5
  GAR_PROJECT: antfly-image-artifacts
  GAR_REPOSITORY: antfly-labs

jobs:
  # Build and publish Termite Operator and Proxy images
  publish-termite-operator-images:
    # runs-on:
    #   - codebuild-GitHubActionsRunnerTermite-${{ github.run_id }}-${{ github.run_attempt }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write # Required for keyless signing with OIDC and GCP WIF

    steps:
      - uses: actions/checkout@v6

      # Authenticate with Docker Hub to avoid rate limits when pulling base images
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Set up QEMU for multi-architecture emulation
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # Set up Docker Buildx for advanced build features
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Authenticate with GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Authenticate to Google Cloud using Workload Identity Federation
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          token_format: "access_token"

      # Login to Google Artifact Registry
      - name: Login to Google Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GAR_LOCATION }}-docker.pkg.dev
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}

      # Extract version from tag (e.g., termite-operator-v0.1.0 -> v0.1.0)
      - name: Extract version
        id: version
        run: |
          TAG="${{ inputs.tag_name || github.ref_name }}"
          VERSION="${TAG#termite-operator-}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION}"

      # Build termite-proxy (routing proxy, multi-arch)
      - name: Build and push termite-proxy
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.proxy
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/antflydb/termite-proxy:latest
            ghcr.io/antflydb/termite-proxy:${{ steps.version.outputs.version }}
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_PROJECT }}/${{ env.GAR_REPOSITORY }}/termite-proxy:latest
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_PROJECT }}/${{ env.GAR_REPOSITORY }}/termite-proxy:${{ steps.version.outputs.version }}
          cache-from: type=gha,scope=termite-proxy
          cache-to: type=gha,mode=max,scope=termite-proxy

      # Build termite-operator (Kubernetes operator, multi-arch)
      - name: Build and push termite-operator
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.operator
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/antflydb/termite-operator:latest
            ghcr.io/antflydb/termite-operator:${{ steps.version.outputs.version }}
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_PROJECT }}/${{ env.GAR_REPOSITORY }}/termite-operator:latest
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_PROJECT }}/${{ env.GAR_REPOSITORY }}/termite-operator:${{ steps.version.outputs.version }}
          cache-from: type=gha,scope=termite-operator
          cache-to: type=gha,mode=max,scope=termite-operator

      # Install cosign for container image signing
      - uses: sigstore/cosign-installer@v3

      # Sign all images with keyless OIDC
      - name: Sign container images (keyless)
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Sign termite-proxy images
          for tag in latest "${VERSION}"; do
            cosign sign --yes \
              -a "repo=${{ github.repository }}" \
              -a "workflow=${{ github.workflow }}" \
              -a "ref=${{ github.sha }}" \
              ghcr.io/antflydb/termite-proxy:${tag}
          done

          # Sign termite-operator images
          for tag in latest "${VERSION}"; do
            cosign sign --yes \
              -a "repo=${{ github.repository }}" \
              -a "workflow=${{ github.workflow }}" \
              -a "ref=${{ github.sha }}" \
              ghcr.io/antflydb/termite-operator:${tag}
          done

      # Sign GAR images
      - name: Sign GAR images (keyless)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          GAR_BASE="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_PROJECT }}/${{ env.GAR_REPOSITORY }}"

          # Sign termite-proxy images
          for tag in latest "${VERSION}"; do
            cosign sign --yes \
              -a "repo=${{ github.repository }}" \
              -a "workflow=${{ github.workflow }}" \
              -a "ref=${{ github.sha }}" \
              ${GAR_BASE}/termite-proxy:${tag}
          done

          # Sign termite-operator images
          for tag in latest "${VERSION}"; do
            cosign sign --yes \
              -a "repo=${{ github.repository }}" \
              -a "workflow=${{ github.workflow }}" \
              -a "ref=${{ github.sha }}" \
              ${GAR_BASE}/termite-operator:${tag}
          done
